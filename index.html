<!DOCTYPE html>
<html>
<head>
  <title>äº²äº²äº²äº²äº²ï¼</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <style>
    body { text-align: center; background: #f0f0f0; font-family: sans-serif; }
    .container { position: relative; display: inline-block; margin-top: 20px; }
    video, canvas { position: absolute; left: 0; top: 0; border-radius: 10px; }
    #status { margin-top: 500px; font-size: 24px; color: #ff4757; font-weight: bold; }
  </style>
</head>
<body>

  <h2>äº²ä¸€äº²ï¼Œä½ æœ€çˆ±çš„ä¸œè¥¿å°±ä¼šåœ¨ä½ èº«è¾¹</h2>
  <div class="container">
    <video id="webcam" style="display:none;" autoplay playsinline></video>
    <canvas id="output_canvas" width="640" height="480"></canvas>
  </div>
  <div id="status">æ£€æµ‹ä¸­...</div>

<script>
const videoElement = document.getElementById('webcam');
const canvasElement = document.getElementById('output_canvas');
const canvasCtx = canvasElement.getContext('2d');
const statusDiv = document.getElementById('status');

// åˆå§‹åŒ– FaceMesh
const faceMesh = new FaceMesh({locateFile: (file) => {
  return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
}});

faceMesh.setOptions({
  maxNumFaces: 1,
  refineLandmarks: true,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

faceMesh.onResults(onResults);

// å¯åŠ¨æ‘„åƒå¤´
const camera = new URLSearchParams(window.location.search).get('camera');
navigator.mediaDevices.getUserMedia({video: {width: 640, height: 480}})
  .then(stream => {
    videoElement.srcObject = stream;
    videoElement.play();
    renderLoop();
  });

async function renderLoop() {
  await faceMesh.send({image: videoElement});
  requestAnimationFrame(renderLoop);
}

function onResults(results) {
  canvasCtx.save();
  canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
  
  // ç»˜åˆ¶è§†é¢‘èƒŒæ™¯
  canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

  if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
    const landmarks = results.multiFaceLandmarks[0];

    // è·å–å…³é”®ç‚¹ (åŸºäº Mediapipe ç´¢å¼•)
    // 61: å·¦å˜´è§’, 291: å³å˜´è§’
    // 0: ä¸Šå”‡é¡¶, 17: ä¸‹å”‡åº•
    const leftMouth = landmarks[61];
    const rightMouth = landmarks[291];
    const topLip = landmarks[0];
    const bottomLip = landmarks[17];

    // è®¡ç®—å˜´å·´çš„å®½åº¦å’Œé«˜åº¦
    const mouthWidth = Math.hypot(leftMouth.x - rightMouth.x, leftMouth.y - rightMouth.y);
    const mouthHeight = Math.hypot(topLip.x - bottomLip.x, topLip.y - bottomLip.y);

    // æ’…å˜´åˆ¤æ–­é€»è¾‘ï¼šé«˜å®½æ¯”å¢åŠ 
    // æ­£å¸¸çŠ¶æ€æ¯”å€¼è¾ƒå°ï¼Œæ’…å˜´æ—¶å˜´å·´å˜çª„å˜é«˜
    const ratio = mouthHeight / mouthWidth;

    if (ratio > 0.55) { // è¿™ä¸ªé˜ˆå€¼å¯ä»¥æ ¹æ®å®é™…æµ‹è¯•å¾®è°ƒ
      statusDiv.innerText = "äº²äº²ï¼ğŸ‘‚ğŸ‘‚";
      drawEars(landmarks);
    } else {
      statusDiv.innerText = "æ¥ï¼Œæ’…ä¸ªå˜´çœ‹çœ‹ï¼Ÿ";
    }
  }
  canvasCtx.restore();
}

function drawEars(landmarks) {
  // è·å–é¢éƒ¨ä¸¤ä¾§çš„åæ ‡ï¼ˆç”¨äºæ”¾ç½®è€³æœµï¼‰
  // 234: è„¸å·¦ä¾§, 454: è„¸å³ä¾§
  const leftFace = landmarks[234];
  const rightFace = landmarks[454];

  canvasCtx.font = "80px serif";
  canvasCtx.textAlign = "center";
  
  // ç»˜åˆ¶å·¦è€³æœµ
  canvasCtx.fillText("ğŸ‘‚", leftFace.x * canvasElement.width - 40, leftFace.y * canvasElement.height);
  // ç»˜åˆ¶å³è€³æœµ (ç¿»è½¬æ•ˆæœå¯ä»¥é€šè¿‡ scale å®ç°ï¼Œè¿™é‡Œç®€å•å¤„ç†)
  canvasCtx.fillText("ğŸ‘‚", rightFace.x * canvasElement.width + 40, rightFace.y * canvasElement.height);
}
</script>
</body>

</html>

